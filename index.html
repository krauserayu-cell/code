<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamJob AI</title>
    <!-- 1. 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 3. 載入 Babel (讓瀏覽器看懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 自定義動畫樣式 */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 圖示組件 (將 import 替換為直接定義 SVG) ---
        const Sparkles = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>;
        const Upload = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const Camera = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
        const Briefcase = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const Loader2 = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Wand2 = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.648 2.352 1.285 4.54a1 1 0 0 1-.683 1.25l-4.54 1.284a1 1 0 0 1-1.25-.683l-1.285-4.541a1 1 0 0 1 .683-1.25l4.54-1.284a1 1 0 0 1 1.25.683z"/><path d="m2.352 21.648 1.285-4.54a1 1 0 0 1 .683-1.25l4.54-1.284a1 1 0 0 1 1.25.683l1.285 4.541a1 1 0 0 1-.683 1.25l-4.54 1.284a1 1 0 0 1-1.25-.683z"/><path d="M12 12 8 8"/><path d="m16 16-4-4"/></svg>;
        const AlertCircle = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const User = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const CheckCircle2 = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>;
        const Sliders = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></svg>;
        const Info = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;

        // --- 主程式邏輯 (App) ---
        function App() {
            const [apiKey, setApiKey] = useState('');
            const [profession, setProfession] = useState('');
            const [uploadedImage, setUploadedImage] = useState(null);
            const [imageBase64, setImageBase64] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [resultImage, setResultImage] = useState(null);
            const [error, setError] = useState('');
            const [status, setStatus] = useState('');
            const [useDemoMode, setUseDemoMode] = useState(true);
            const [identityStrength, setIdentityStrength] = useState(0.85);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadedImage(URL.createObjectURL(file));
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImageBase64(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const simulateGeneration = () => {
                setIsGenerating(true);
                setError('');
                setResultImage(null);

                const steps = [
                    "正在分析臉部特徵...",
                    "正在提取 Face ID Embedding...",
                    `正在構建${profession || '職業'}場景...`,
                    "⚠️ 演示模式：將展示範例結果 (非真實運算)...",
                    "最後潤飾中..."
                ];

                let stepIndex = 0;
                setStatus(steps[0]);

                const interval = setInterval(() => {
                    stepIndex++;
                    if (stepIndex < steps.length) {
                        setStatus(steps[stepIndex]);
                    } else {
                        clearInterval(interval);
                        setIsGenerating(false);
                        setResultImage("https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&q=80&w=800&ixlib=rb-4.0.3");
                        setStatus("生成完成！(這是演示圖片，請使用 API Key 進行真實生成)");
                    }
                }, 1500);
            };

            const generateRealImage = async () => {
                if (!apiKey) {
                    setError("請輸入 Replicate API Token");
                    return;
                }

                setIsGenerating(true);
                setError('');
                setResultImage(null);
                setStatus("正在連接 AI 模型...");

                try {
                    const prompt = `A realistic portrait of a person working as a ${profession}, exact facial features, same face, professional photography, high quality, 8k, detailed skin texture, looking at camera`;
                    
                    const response = await fetch("https://api.replicate.com/v1/predictions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Token ${apiKey}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            version: "c62584d436427d1136b607066928e44280145c387d7b1b0179f87424b9173d12",
                            input: {
                                image: imageBase64,
                                prompt: prompt,
                                negative_prompt: "low quality, blurry, distorted face, ugly, extra fingers, cartoon, anime, different face",
                                identity_scale: parseFloat(identityStrength), 
                                adapter_strength: parseFloat(identityStrength),
                                num_inference_steps: 30,
                                guidance_scale: 5
                            }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 401) throw new Error("API Key 無效或過期");
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.detail || "請求失敗");
                    }

                    const prediction = await response.json();
                    const getUrl = prediction.urls.get;

                    setStatus(`AI 正在繪圖中 (強度: ${identityStrength})...`);
                    
                    const checkStatus = async () => {
                        const pollResponse = await fetch(getUrl, {
                            headers: {
                                "Authorization": `Token ${apiKey}`,
                                "Content-Type": "application/json",
                            }
                        });
                        const pollData = await pollResponse.json();

                        if (pollData.status === "succeeded") {
                            setResultImage(pollData.output[0]);
                            setIsGenerating(false);
                            setStatus("生成成功！");
                        } else if (pollData.status === "failed") {
                            setIsGenerating(false);
                            setError("生成失敗，請稍後再試。");
                        } else {
                            setTimeout(checkStatus, 3000);
                        }
                    };

                    checkStatus();

                } catch (err) {
                    console.error(err);
                    setIsGenerating(false);
                    if (err.name === 'TypeError' && err.message === 'Failed to fetch') {
                        setError("瀏覽器安全性阻擋 (CORS Error)：Google Sites 不允許直接連線到 AI 伺服器。請使用「演示模式」，或者您需要建立自己的後端伺服器。");
                    } else {
                        setError(err.message || "發生未知錯誤");
                    }
                }
            };

            const handleSubmit = () => {
                if (!uploadedImage) {
                    setError("請先上傳一張照片");
                    return;
                }
                if (!profession) {
                    setError("請輸入你想擔任的職業");
                    return;
                }
                if (useDemoMode) {
                    simulateGeneration();
                } else {
                    generateRealImage();
                }
            };

            // --- 渲染畫面 (UI) ---
            return (
                <div className="min-h-screen bg-slate-900 text-white font-sans selection:bg-purple-500 selection:text-white pb-10">
                    <header className="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-gradient-to-tr from-purple-500 to-pink-500 p-2 rounded-lg">
                                    <Sparkles className="w-5 h-5 text-white" />
                                </div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                                    DreamJob AI
                                </h1>
                            </div>
                            <div className="text-xs text-slate-400 border border-slate-700 px-3 py-1 rounded-full">
                                Powered by InstantID
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto px-6 py-10">
                        <div className="text-center mb-10 space-y-4">
                            <h2 className="text-4xl md:text-5xl font-extrabold tracking-tight">
                                遇見<span className="text-purple-400">未來</span>的自己
                            </h2>
                            <p className="text-slate-400 max-w-xl mx-auto text-lg">
                                上傳一張自拍照，輸入夢想職業，AI 將為你生成高度擬真的職業形象照。
                            </p>
                        </div>

                        <div className="grid md:grid-cols-2 gap-8 items-start">
                            <div className="space-y-6">
                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                    <div className="flex items-center justify-between mb-2">
                                        <label className="text-sm font-medium text-slate-300">運行模式</label>
                                        <button 
                                            onClick={() => setUseDemoMode(!useDemoMode)}
                                            className={`text-xs px-2 py-1 rounded transition-colors ${useDemoMode ? 'bg-green-500/20 text-green-400' : 'bg-purple-500/20 text-purple-400'}`}
                                        >
                                            {useDemoMode ? "當前：演示模式" : "當前：真實模式 (需 API Key)"}
                                        </button>
                                    </div>
                                    {!useDemoMode && (
                                        <div className="mt-3">
                                            <input
                                                type="password"
                                                placeholder="輸入 Replicate API Token (r8_...)"
                                                value={apiKey}
                                                onChange={(e) => setApiKey(e.target.value)}
                                                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all text-white"
                                            />
                                            <div className="flex items-start gap-2 mt-2 text-xs text-yellow-500/80 bg-yellow-500/10 p-2 rounded">
                                                <Info size={14} className="mt-0.5 flex-shrink-0" />
                                                <p>注意：Google Sites 幾乎一定會阻擋真實的 API 連線 (CORS)，真實生成可能無法運作。</p>
                                            </div>
                                        </div>
                                    )}
                                    {useDemoMode && <p className="text-xs text-slate-500 text-green-400/80">✓ 推薦使用：演示模式可直接體驗完整介面流程。</p>}
                                </div>

                                <div className={`relative group border-2 border-dashed rounded-2xl p-8 transition-all duration-300 text-center cursor-pointer overflow-hidden
                                    ${uploadedImage ? 'border-purple-500/50 bg-purple-500/5' : 'border-slate-700 hover:border-purple-500 hover:bg-slate-800'}`}>
                                    <input type="file" accept="image/*" onChange={handleImageUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                    {uploadedImage ? (
                                        <div className="relative z-0">
                                            <img src={uploadedImage} alt="Preview" className="h-48 mx-auto rounded-lg object-cover shadow-lg" />
                                            <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                                                <p className="text-white font-medium flex items-center gap-2"><Camera size={16} /> 更換照片</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="py-8 space-y-3">
                                            <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform duration-300">
                                                <Upload className="text-purple-400 w-8 h-8" />
                                            </div>
                                            <div>
                                                <p className="text-lg font-medium text-slate-200">點擊上傳大頭照</p>
                                                <p className="text-sm text-slate-500">支援 JPG, PNG</p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-slate-300 flex items-center gap-2"><Briefcase size={16} /> 未來職業</label>
                                    <input
                                        type="text"
                                        value={profession}
                                        onChange={(e) => setProfession(e.target.value)}
                                        placeholder="例如: Astronaut, Doctor, Chef..."
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
                                    />
                                </div>

                                <div className="space-y-3 bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                                    <div className="flex justify-between text-sm">
                                        <label className="font-medium text-slate-300 flex items-center gap-2"><Sliders size={14} /> 臉部相似度</label>
                                        <span className="text-purple-400 font-bold">{Math.round(identityStrength * 100)}%</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="0.5"
                                        max="1.0"
                                        step="0.05"
                                        value={identityStrength}
                                        onChange={(e) => setIdentityStrength(e.target.value)}
                                        className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500"
                                    />
                                </div>

                                <button
                                    onClick={handleSubmit}
                                    disabled={isGenerating}
                                    className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all duration-300 transform active:scale-95
                                        ${isGenerating ? 'bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white shadow-purple-500/25'}`}
                                >
                                    {isGenerating ? <><Loader2 className="animate-spin" /> AI 運算中...</> : <><Wand2 /> 生成未來照片</>}
                                </button>

                                {error && (
                                    <div className="bg-red-500/10 border border-red-500/50 text-red-400 p-4 rounded-lg flex items-start gap-3 text-sm">
                                        <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                                        <p className="leading-relaxed">{error}</p>
                                    </div>
                                )}
                            </div>

                            <div className="bg-slate-800/50 rounded-3xl border border-slate-700 p-6 min-h-[500px] flex flex-col items-center justify-center relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -z-10" />
                                <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -z-10" />

                                {!resultImage && !isGenerating && (
                                    <div className="text-center text-slate-500 space-y-4">
                                        <div className="w-20 h-20 bg-slate-800 rounded-2xl rotate-3 mx-auto flex items-center justify-center border border-slate-700">
                                            <User className="w-10 h-10 opacity-50" />
                                        </div>
                                        <p>生成的照片將會顯示在這裡</p>
                                    </div>
                                )}

                                {isGenerating && (
                                    <div className="text-center space-y-6 animate-pulse">
                                        <div className="w-32 h-32 rounded-full border-4 border-purple-500/30 border-t-purple-500 animate-spin mx-auto" />
                                        <div className="space-y-2">
                                            <h3 className="text-xl font-medium text-white">AI 正在施法</h3>
                                            <p className="text-purple-300">{status}</p>
                                        </div>
                                    </div>
                                )}

                                {resultImage && (
                                    <div className="w-full space-y-4">
                                        <div className="relative group">
                                            <img src={resultImage} alt="Result" className="w-full rounded-xl shadow-2xl border border-slate-600" />
                                            {useDemoMode && (
                                                <div className="absolute inset-x-0 bottom-0 bg-black/70 p-2 text-center text-xs text-yellow-300">
                                                    ⚠️ 此為演示圖片，並非使用您的臉部生成
                                                </div>
                                            )}
                                        </div>
                                        <button className="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm font-medium transition-colors" onClick={() => setResultImage(null)}>
                                            重試
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        // 啟動 React
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
